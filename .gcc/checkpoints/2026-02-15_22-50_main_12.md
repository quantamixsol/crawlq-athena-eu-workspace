### COMMIT 12 — 2026-02-15T22:50:00Z
**Milestone:** Critical routing fix — ALL Lambda Function URLs blocked by AWS org SCP (403). Discovered via comprehensive URL audit. Fixed by routing everything through API Gateway (1v186le2ee). Removed 19 blocked Function URL env vars from Amplify. Fixed hardcoded Function URLs in region-config.ts (chatJobQueue, chatJobStatus). Added deep_research mode to backend handler (8192 tokens, auto web search, 6-section analysis prompt). All 8 critical endpoints verified working through API Gateway. Build #48 SUCCEED (b424268). Backend b2b043d pushed.
**State:** DONE
**Files Changed:**
- MODIFIED: crawlq-chat-athena-eu-frontend/src/config/region-config.ts — Removed all env var overrides + hardcoded Function URLs; all 20 endpoints now use `${EU_API_BASE}/path` (API Gateway)
- MODIFIED: crawlq-chat-athena-eu-frontend/.env.local — Removed 19 Function URL env vars (blocked by SCP), kept only API Gateway + Cognito + DynamoDB vars
- MODIFIED: crawlq-athena-eu-backend/SemanticGraphEU/EUChatAthenaBot/handler.py — Added deep_research flag: extracts from body, increases max_tokens to 8192, auto-enables web search, appends 6-section analysis system prompt
- UPDATED: Amplify env vars — removed 19 Function URL vars, kept 12 essential vars
- DEPLOYED: eu_chat_athena_bot Lambda (78891 bytes) with deep_research support
- COMMITTED: b424268 (frontend), b2b043d (backend)
- BUILD: #48 SUCCEED
**Key Decisions:**
- ALL Lambda Function URLs return 403 due to AWS organization SCP policy — this is an account-level restriction, not per-function
- Frontend MUST route ALL requests through API Gateway (1v186le2ee) — no Function URL fallbacks
- chatJobQueue and chatJobStatus were hardcoded Function URLs in region-config.ts — changed to API Gateway /chat-async and /chat-status
- Upload endpoint works through API Gateway /upload (binary payload handled by Lambda, not API Gateway)
- Deep research in chat handler: auto-enables web search + extends max_tokens + appends structured analysis prompt
**Next:**
- [ ] Verify document upload works end-to-end on live site
- [ ] Verify deep research produces extensive TRACE-scored responses
- [ ] Verify subscription endpoint returns Enterprise tier
- [ ] Full Pallas E2E regression
- [ ] Production launch
**Blockers:** None
